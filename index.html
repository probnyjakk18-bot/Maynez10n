<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Hello Neighbor: Gemini Ultimate</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* UI Элементы */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; color: #0f0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: rgba(255, 255, 255, 0.8); border: 1px solid black;
            transform: translate(-50%, -50%); border-radius: 50%;
        }
        
        #stamina-bar {
            position: absolute; bottom: 20px; left: 20px; width: 200px; height: 10px;
            background: #333; border: 2px solid #555;
        }
        #stamina-fill { width: 100%; height: 100%; background: orange; transition: width 0.1s; }
        
        #ai-debug {
            position: absolute; top: 20px; right: 20px; text-align: right;
            color: #0f0; text-shadow: 1px 1px 0 #000; font-size: 14px;
        }

        #jumpscare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; display: none; z-index: 900;
            align-items: center; justify-content: center; font-size: 100px; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loader">
        <h1>ЗАГРУЗКА ДВИЖКА...</h1>
        <h2 id="progress">0%</h2>
        <p>Убедись, что запущен Live Server!</p>
    </div>

    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="stamina-bar"><div id="stamina-fill"></div></div>
        <div id="ai-debug">
            Gemini Neural Link: ONLINE<br>
            Состояние: <span id="neighbor-state">IDLE</span>
        </div>
        <div id="jumpscare">ПОЙМАН!</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import * as CANNON from 'cannon-es';

        // ==========================================
        // НАСТРОЙКИ И КОНСТАНТЫ
        // ==========================================
        const CONFIG = {
            apiKey: "AIzaSyB9R7JwtXb0CFrc-s4MPT7iBgofZjQcvGE", // Твой ключ
            houseFile: 'neighbor_house_from_hello_neighbor_2.glb',
            neighborFile: 'hello_neighbor_mr._peterson_hn_release.glb',
            playerSpeed: 8,
            sprintSpeed: 14,
            jumpForce: 7,
            neighborSpeed: 8.5
        };

        // ==========================================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ==========================================
        const scene = new THREE.Scene();
        const world = new CANNON.World();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        let controls;
        let lastTime = 0;
        
        // Объекты игры
        const gameObjects = {
            player: { body: null, mesh: null, stamina: 100 },
            neighbor: { body: null, mesh: null, mixer: null, action: 'PATROL' },
            house: null
        };
        
        const inputs = { w: false, a: false, s: false, d: false, shift: false, space: false };

        // ==========================================
        // 1. ИНИЦИАЛИЗАЦИЯ МИРА
        // ==========================================
        function initWorld() {
            // Графика
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            scene.background = new THREE.Color(0x050510); // Ночь
            scene.fog = new THREE.FogExp2(0x050510, 0.02);

            // Физика
            world.gravity.set(0, -15, 0); // Тяжелее гравитация для реализма
            const material = new CANNON.Material();
            const contactMat = new CANNON.ContactMaterial(material, material, { friction: 0.0, restitution: 0.0 });
            world.addContactMaterial(contactMat);

            // Свет
            const ambi = new THREE.AmbientLight(0x404040, 1.5); 
            scene.add(ambi);
            
            const moon = new THREE.DirectionalLight(0xaaccff, 0.5);
            moon.position.set(50, 100, 50);
            moon.castShadow = true;
            moon.shadow.mapSize.width = 2048;
            moon.shadow.mapSize.height = 2048;
            scene.add(moon);

            // Фонарик игрока
            const flashLight = new THREE.SpotLight(0xffffff, 50, 40, 0.5, 0.5, 1);
            flashLight.position.set(0,0,0);
            camera.add(flashLight);
            flashLight.target.position.set(0, 0, -1);
            camera.add(flashLight.target);
            scene.add(camera);
        }

        // ==========================================
        // 2. ЗАГРУЗКА РЕСУРСОВ (САМОЕ ВАЖНОЕ)
        // ==========================================
        function loadAssets() {
            const manager = new THREE.LoadingManager();
            const loader = new GLTFLoader(manager);
            const progressDiv = document.getElementById('progress');

            manager.onProgress = (url, itemsLoaded, itemsTotal) => {
                const percent = Math.round((itemsLoaded / itemsTotal) * 100);
                progressDiv.innerText = percent + "%";
            };

            manager.onLoad = () => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                startGame();
            };

            // Пол (Физический и Визуальный)
            const groundGeo = new THREE.PlaneGeometry(200, 200);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.8 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            const groundBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: new CANNON.Plane() });
            groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
            world.addBody(groundBody);

            // 2.1 ЗАГРУЗКА ДОМА
            loader.load(CONFIG.houseFile, (gltf) => {
                const house = gltf.scene;
                house.scale.set(0.04, 0.04, 0.04); // Масштабирование
                house.position.set(0, 0.1, -15);
                
                house.traverse(child => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        // Генерация простой физики для стен (упрощенно: коробки вокруг крупных объектов)
                    }
                });
                scene.add(house);
                
                // Добавляем невидимый куб физики дома (чтобы не проходить сквозь центр)
                const houseBody = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(5, 5, 5)), position: new CANNON.Vec3(0, 5, -15) });
                world.addBody(houseBody);
            });

            // 2.2 ЗАГРУЗКА СОСЕДА
            loader.load(CONFIG.neighborFile, (gltf) => {
                const neighbor = gltf.scene;
                neighbor.scale.set(2.2, 2.2, 2.2);
                neighbor.traverse(c => { if(c.isMesh) c.castShadow = true; });
                scene.add(neighbor);
                gameObjects.neighbor.mesh = neighbor;

                // Физика соседа
                const shape = new CANNON.Cylinder(1, 1, 4, 8);
                const body = new CANNON.Body({ mass: 10, fixedRotation: true, position: new CANNON.Vec3(10, 5, 0) });
                body.addShape(shape);
                world.addBody(body);
                gameObjects.neighbor.body = body;
            });
        }

        // ==========================================
        // 3. ИГРОК
        // ==========================================
        function setupPlayer() {
            // Физика
            const shape = new CANNON.Sphere(1.2);
            const body = new CANNON.Body({ mass: 70, fixedRotation: true, position: new CANNON.Vec3(0, 5, 10) });
            body.addShape(shape);
            body.linearDamping = 0.95;
            world.addBody(body);
            gameObjects.player.body = body;

            // Камера
            controls = new PointerLockControls(camera, document.body);
            document.addEventListener('click', () => controls.lock());
            
            // Управление
            const onKey = (code, pressed) => {
                if(code === 'KeyW') inputs.w = pressed;
                if(code === 'KeyA') inputs.a = pressed;
                if(code === 'KeyS') inputs.s = pressed;
                if(code === 'KeyD') inputs.d = pressed;
                if(code === 'ShiftLeft') inputs.shift = pressed;
                if(code === 'Space' && pressed) tryJump();
            };
            document.addEventListener('keydown', e => onKey(e.code, true));
            document.addEventListener('keyup', e => onKey(e.code, false));
        }

        function tryJump() {
            // Простая проверка "на земле"
            if(Math.abs(gameObjects.player.body.velocity.y) < 0.5) {
                gameObjects.player.body.velocity.y = CONFIG.jumpForce;
            }
        }

        // ==========================================
        // 4. НЕЙРОННЫЙ МОЗГ (GEMINI API)
        // ==========================================
        async function updateNeighborAI() {
            if(!gameObjects.neighbor.body) return;

            const nPos = gameObjects.neighbor.body.position;
            const pPos = gameObjects.player.body.position;
            const dist = nPos.distanceTo(pPos);

            // Если игрок очень близко, сразу погоня (без запроса к API для скорости)
            if(dist < 5) {
                gameObjects.neighbor.action = "ATTACK";
                document.getElementById('neighbor-state').innerText = "!!! ATTACK !!!";
                document.getElementById('neighbor-state').style.color = "red";
                return;
            }

            // Запрос к Gemini
            const prompt = `
                Roleplay: You are the Neighbor in a horror game.
                Player Pos: ${Math.round(pPos.x)}, ${Math.round(pPos.z)}.
                My Pos: ${Math.round(nPos.x)}, ${Math.round(nPos.z)}.
                Distance: ${Math.round(dist)}.
                Obstacles: True.
                
                Decide next move (choose ONE):
                CHASE (if seen or close), PATROL (if far), JUMP (to shortcut), HIDE (ambush).
                Output only the word.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const decision = data.candidates[0].content.parts[0].text.trim();
                
                gameObjects.neighbor.action = decision;
                document.getElementById('neighbor-state').innerText = decision;
                document.getElementById('neighbor-state').style.color = (decision === "CHASE") ? "orange" : "lime";

            } catch (e) {
                console.log("AI Thinking...");
            }
        }

        // ==========================================
        // 5. ИГРОВОЙ ЦИКЛ (PHYSICS & LOGIC)
        // ==========================================
        function startGame() {
            setupPlayer();
            setInterval(updateNeighborAI, 2500); // Мозг думает каждые 2.5 сек
            requestAnimationFrame(renderLoop);
        }

        function renderLoop(time) {
            requestAnimationFrame(renderLoop);
            const dt = (time - lastTime) / 1000;
            lastTime = time;

            world.step(1/60, dt, 3);

            // --- Логика Игрока ---
            if(controls.isLocked) {
                const speed = inputs.shift ? CONFIG.sprintSpeed : CONFIG.playerSpeed;
                const forward = new THREE.Vector3();
                const right = new THREE.Vector3();
                
                // Получаем направление камеры, игнорируя наклон Y
                camera.getWorldDirection(forward);
                forward.y = 0; forward.normalize();
                right.crossVectors(camera.up, forward).normalize(); // Инверсия для three.js

                const move = new THREE.Vector3();
                if(inputs.w) move.add(forward);
                if(inputs.s) move.sub(forward);
                if(inputs.d) move.add(right); // Исправлено направление
                if(inputs.a) move.sub(right);

                if(move.length() > 0) move.normalize();
                
                gameObjects.player.body.velocity.x = move.x * speed;
                gameObjects.player.body.velocity.z = move.z * speed;

                // Стамина
                const bar = document.getElementById('stamina-fill');
                if(inputs.shift && inputs.w) {
                    gameObjects.player.stamina = Math.max(0, gameObjects.player.stamina - 0.5);
                } else {
                    gameObjects.player.stamina = Math.min(100, gameObjects.player.stamina + 0.2);
                }
                bar.style.width = gameObjects.player.stamina + "%";
            }
            
            camera.position.copy(gameObjects.player.body.position);
            camera.position.y += 1.6; // Высота глаз

            // --- Логика Соседа ---
            if(gameObjects.neighbor.body && gameObjects.neighbor.mesh) {
                const body = gameObjects.neighbor.body;
                const mesh = gameObjects.neighbor.mesh;
                const pPos = gameObjects.player.body.position;

                // Синхронизация графики
                mesh.position.copy(body.position);
                mesh.position.y -= 2; // Центровка модели по вертикали относительно капсулы

                // Исполнение приказов Gemini
                const action = gameObjects.neighbor.action;
                const speed = (action === "CHASE" || action === "ATTACK") ? CONFIG.neighborSpeed * 1.2 : 3;

                if (action === "CHASE" || action === "ATTACK") {
                    const dir = new THREE.Vector3(pPos.x - body.position.x, 0, pPos.z - body.position.z).normalize();
                    body.velocity.x = dir.x * speed;
                    body.velocity.z = dir.z * speed;
                    mesh.lookAt(pPos.x, mesh.position.y, pPos.z);
                }
                
                if (action.includes("JUMP") && Math.abs(body.velocity.y) < 0.1) {
                    body.velocity.y = 12; // High jump
                }

                // Условие проигрыша
                if(body.position.distanceTo(pPos) < 2) {
                    document.getElementById('jumpscare').style.display = 'flex';
                    controls.unlock();
                }
            }

            renderer.render(scene, camera);
        }

        // Старт
        initWorld();
        loadAssets(); // Это запустит загрузчик

        // Адаптив
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
